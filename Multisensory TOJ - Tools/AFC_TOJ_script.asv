clear allInitializePsychSound;hideCursor;% enter subjects informationsubjID = input('Subject ID (e.g., 01xyz): ','s');data.subjID = str2num(subjID);sex = input('Subject sex (m or f): ','s');data.sex=sex;age = input('Subject age: ','s');data.age = str2num(age);date = input('Date (year-month-day): ','s');data.date = str2num(date);%make ordertrials = 25;%offsets = [0];offsets = [300 250 200 150 100 50 0 -50 -100 -150 -200 -250 -300];maxTrials = length(offsets)* trials;order(1:maxTrials,1) = 3;for i = 1:length(offsets)    order(i*trials-trials+1:i*trials,2) = offsets(i);    if offsets(i) == 0        order(i*trials-trials+1:i*trials,3) = 0;    elseif offsets(i) > 0        order(i*trials-trials+1:i*trials,3) = 1;    elseif offsets(i) < 0        order(i*trials-trials+1:i*trials,3) = 2;    endend    %randomize trial ordersnewOrder=randperm(maxTrials);for i=1:maxTrials    stimOrder(i,:)=order(newOrder(i),:);endclear newOrder orderdata.stimOrder=stimOrder;data.stimOrder_guide.Column1= 'modality: 1=A, 2=V, 3=AV';data.stimOrder_guide.Column2 = 'temporal offset, + is VA, negative is AV';data.stimOrder_guide.Column3 = 'order, 0 = sync, 1 = V first, 2 = A first';%create file name to saverepeat=1;while 1    fname=sprintf('%s%sDATA%s%s_TOJ_%d',pwd,filesep,filesep,subjID,repeat);    if exist(fname)==2,        repeat=repeat+1;    else        break;    endend% audio RMS equation values - THESE NEED TO BE RECALIBRATEDe=2.718;m=9.76;b=102.2;% open window using 32 bitsscrAvail = Screen('Screens');scr0 = scrAvail(2);%scr0 = scrAvail(length(scrAvail));%[win0, outRect] = Screen('OpenWindow',scr0,0,rect0,32,2);[win0, outRect] = Screen('OpenWindow',scr0,0,[],32,2);rect0 = outRect;clut = [[0:255]' [0:255]' [0:255]'];oldclut = Screen('LoadCLUT',win0,clut,0);cWhite0 = 255;cBlack0 = 0;cGrey0 = 160;Screen('TextSize',win0,16');Screen('TextFont',win0,'Geneva');hz = screen('FrameRate', win0);%visual stimuli % stimulus RECTload fixation400cross = Screen('MakeTexture',win0,fixation);load saws400videoFrames = 30;for i = 1:videoFrames    video(i) = Screen('MakeTexture',win0,saw1(:,:,i));endstimSize=length(saw1(:,1,1));stimRect = [1 1 stimSize stimSize];rectS=centerRect([1 1 stimSize stimSize],rect0);load audaudio = aud(5,1:32032);audio50 = [zeros(1,1602) audio];audio100 = [zeros(1,1602*2) audio];audio150 = [zeros(1,1602*3) audio];audio200 = [zeros(1,1602*4) audio];audio250 = [zeros(1,1602*5) audio];audio300 = [zeros(1,1602*6) audio];audio = audioplayer(audio,32032);audio50 = audioplayer(audio50,32032);audio100 = audioplayer(audio100,32032);audio150 = audioplayer(audio150,32032);audio200 = audioplayer(audio200,32032);audio250 = audioplayer(audio250,32032);audio300 = audioplayer(audio300,32032);%allTrials(trial, modality, stimlevel, stimulus, onset time, word time,%offset time, response, corect response, mark)allTrials=zeros(1,10);% create responsesallKeys='zm';fused = 'm';unfused = 'z';%wait screenSCREEN('DrawText',win0,'Your task will be to decide if the beep or flash was playerd FIRST.',50,50,cWhite0);SCREEN('DrawText',win0,'If the auditory beep came first, press "z".',50,150,cWhite0);SCREEN('DrawText',win0,'If the visual flash came first, press "m".',50,200,cWhite0);SCREEN('DrawText',win0,'Press the spacebar to continue.',50,450,cWhite0);Screen('Flip',win0);key='';while 1,    key=getchar;    if findstr(key,' '),        break;    end;end%%%Begin experimenttic;SCREEN('FillRect',win0,0, rect0);Screen('CopyWindow', cross, win0, stimRect, rectS)Screen('Flip',win0);ans=0;trial=1;while trial<=maxTrials    flushevents('keydown');    % update variable allTrials with next trials info    allTrials(trial,1)=trial;    allTrials(trial,2)=stimOrder(trial,1);    allTrials(trial,3)=stimOrder(trial,2);    allTrials(trial,4)=stimOrder(trial,3);    %find correct answer for upcomming trial    corAns(trial) = 1;    if stimOrder(trial,2) == 0;        corAns(trial) = 0;    end    allTrials(trial,11)=corAns(trial);    data.responses(trial,1)=corAns(trial);        % put up ready screen    Screen('CopyWindow', cross, win0, stimRect, rectS)    Screen('Flip',win0);     waitsecs(.5+rand);    flushevents('keydown');            %Audio preceding Visual    if stimOrder(trial,3)== 2        delay = stimOrder(trial,2);        numDelay = round(delay/hz); %hz is the framerate        Screen('CopyWindow', cross, win0, stimRect, rectS)%make sure you are aligned with a refresh        Screen('Flip',win0);        waitsecs(.001);        play(audio);        timeA = toc;        waitsecs(abs(delay)/1000-.01);%Screen('WaitBlanking',win0,numDelay)%numDelay is # frames to pause        for i = 1:videoFrames            Screen('CopyWindow', video(i), win0, stimRect, rectS)            Screen('Flip',win0);            if i == 1                timeV = toc;            end            Screen('CopyWindow', video(i), win0, stimRect, rectS)            Screen('Flip',win0);        end        realDelay = (timeA-timeV)*1000;    end        %AV synchronus or video preceding    if stimOrder(trial,3)< 2        %choose audio delay        if stimOrder(trial,2) == 0            audioFile = audio;        elseif stimOrder(trial,2) == 50            audioFile = audio50;        elseif stimOrder(trial,2) == 100            audioFile = audio50;        elseif stimOrder(trial,2) == 150            audioFile = audio50;        elseif stimOrder(trial,2) == 200            audioFile = audio50;        elseif stimOrder(trial,2) == 250            audioFile = audio50;        elseif stimOrder(trial,2) == 300            audioFile = audio300;        end        Screen('CopyWindow', cross, win0, stimRect, rectS)        Screen('Flip',win0);        %waitsecs(0.001);        play(audioFile);        timeA = toc;        Screen('CopyWindow', video(1), win0, stimRect, rectS)        Screen('Flip',win0);        timeV = toc;        Screen('CopyWindow', video(1), win0, stimRect, rectS)        Screen('Flip',win0);        for i = 2:videoFrames            Screen('CopyWindow', video(i), win0, stimRect, rectS)            Screen('Flip',win0);            Screen('CopyWindow', video(i), win0, stimRect, rectS)            Screen('Flip',win0);        end        realDelay = (timeA-timeV)*1000;    end        Screen('CopyWindow', cross, win0, stimRect, rectS)    Screen('Flip',win0);        allTrials(trial,5)=timeA;    allTrials(trial,6)=timeV;    allTrials(trial,7)=realDelay;    allTrials(trial,8) = allTrials(trial,7)-allTrials(trial,3);        data.timing(trial,1)=allTrials(trial,5);    data.timing(trial,2)=allTrials(trial,6);    data.timing(trial,3)=allTrials(trial,7);        %present response screen    waitsecs(.25);    SCREEN('DrawText',win0,'asynchronous = z         synchronous = m .',outRect(3)/2-220,outRect(4)/2+50,cWhite0);    Screen('Flip',win0);        %collect response    ans=0;    while ans==0        while charavail            key=getchar;            %key = 'z';            if key=='z'                T=toc;                allTrials(trial,9)=T;                ans(trial)=1;                allTrials(trial,12)=ans(trial);                if allTrials(trial,11)==allTrials(trial,12)                    mark(trial)=1;                else                    mark(trial)=0;                end            elseif key=='m'                T=toc;                allTrials(trial,9)=T;                ans(trial)=2;                allTrials(trial,12)=ans(trial);                if allTrials(trial,11)==allTrials(trial,12)                    mark(trial)=1;                else                    mark(trial)=0;                end            end        end    end        allTrials(trial,10)=allTrials(trial,9)-min([allTrials(trial,5) allTrials(trial,6)]);        data.responses(trial,2)=ans(trial);    if allTrials(trial,11)==allTrials(trial,12)        mark(trial)=1;    else        mark(trial)=0;    end    allTrials(trial,13)=mark(trial);    data.responses(trial,3)=mark(trial);    data.timing(trial,4)=allTrials(trial,9);    flushevents('keydown');    data.allTrials=allTrials;    save(fname,'data','allTrials');    trial=trial+1;endSCREEN('FillRect',win0,160, rect0);SCREEN('DrawText',win0,'saving...',300,rect0(4)/2,0);Screen('Flip',win0);clear SF trim  trial key ans mark corAns rectS;save(fname);showCursor;SCREEN('FillRect',win0,0, rect0);SCREEN('DrawText',win0,'Thanks for your participation. Press spacebar to exit.',100,rect0(4)/2,255);Screen('Flip',win0);key='';while 1,    key=getchar;    if findstr(key,' '),        break;    end;endSCREEN('closeAll');I=find(allTrials(:,4)==1);VAtrials(1) = mean(allTrials(I,8));VAtrials(2) = std(allTrials(I,8));VAtrials(3) = max(abs( allTrials(I,8)));VAtrialsJ=find(allTrials(:,4)==2);AVtrials(1) = mean(allTrials(J,8));AVtrials(2) = std(allTrials(J,8));AVtrials(3) = max(abs(allTrials(J,8)));AVtrialsK=find(allTrials(:,4)==0);SYNCtrials(1) = mean(allTrials(K,8));SYNCtrials(2) = std(allTrials(K,8));SYNCtrials(3) = max(abs(allTrials(K,8)));SYNCtrials